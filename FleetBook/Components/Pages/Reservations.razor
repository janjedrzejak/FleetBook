@page "/reservations"
@using FleetBook.Models
@using FleetBook.Services
@rendermode InteractiveServer
@inject ReservationService ReservationService
@inject CarService CarService
@inject UserService UserService

<PageTitle>Rezerwacje</PageTitle>

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Rezerwacje</h1>
        <button class="btn btn-success" @onclick="CreateNewReservation">
            + Nowa rezerwacja
        </button>
    </div>

    <NewReservationModal @ref="NewReservationModal" 
                        Cars="@availableCars" 
                        Users="@authorizedUsers"
                        OnSave="@SaveNewReservation" />

    @if (reservations == null)
    {
        <p>Ładowanie...</p>
    }
    else
    {
        <!-- Desktop view -->
        <div class="d-none d-lg-block">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Samochód</th>
                            <th>Użytkownik</th>
                            <th>Data rezerwacji</th>
                            <th>Data zwrotu</th>
                            <th>Status</th>
                            <th>Akcje</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var reservation in reservations)
                        {
                            <tr>
                                <td>@reservation.Id</td>
                                <td>
                                    <strong>@reservation.Car.Marka @reservation.Car.Model</strong><br />
                                    <small>@reservation.Car.Rejestracja</small>
                                </td>
                                <td>
                                    @reservation.User.Imie @reservation.User.Nazwisko<br />
                                    <small>@reservation.User.Email</small>
                                </td>
                                <td>@reservation.DataRezerwacji.ToString("dd.MM.yyyy HH:mm")</td>
                                <td>@(reservation.DataZwrotu?.ToString("dd.MM.yyyy HH:mm") ?? "-")</td>
                                <td>
                                    <span class="badge @(reservation.DataZwrotu == null ? "bg-warning" : "bg-success")">
                                        @(reservation.DataZwrotu == null ? "Aktywna" : "Zakończona")
                                    </span>
                                </td>
                                <td>
                                    @if (reservation.DataZwrotu == null)
                                    {
                                        <button class="btn btn-success btn-sm me-1" @onclick="() => ReturnCar(reservation.Id)">
                                            Zwróć
                                        </button>
                                    }
                                    <button class="btn btn-danger btn-sm" @onclick="() => DeleteReservation(reservation.Id)">
                                        Usuń
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Mobile view -->
        <div class="d-lg-none">
            @foreach (var reservation in reservations)
            {
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">ID: @reservation.Id</h6>
                        <div class="row mb-2">
                            <div class="col-12">
                                <strong>Samochód:</strong> @reservation.Car.Marka @reservation.Car.Model (@reservation.Car.Rejestracja)
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-12">
                                <strong>Użytkownik:</strong> @reservation.User.Imie @reservation.User.Nazwisko
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6">
                                <strong>Rezerwacja:</strong> @reservation.DataRezerwacji.ToString("dd.MM")
                            </div>
                            <div class="col-6">
                                <strong>Zwrot:</strong> @(reservation.DataZwrotu?.ToString("dd.MM") ?? "-")
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-12">
                                <span class="badge @(reservation.DataZwrotu == null ? "bg-warning" : "bg-success")">
                                    @(reservation.DataZwrotu == null ? "Aktywna" : "Zakończona")
                                </span>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            @if (reservation.DataZwrotu == null)
                            {
                                <button class="btn btn-success btn-sm flex-grow-1" @onclick="() => ReturnCar(reservation.Id)">
                                    Zwróć
                                </button>
                            }
                            <button class="btn btn-danger btn-sm flex-grow-1" @onclick="() => DeleteReservation(reservation.Id)">
                                Usuń
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<Reservation>? reservations;
    private List<Car>? availableCars;
    private List<User>? authorizedUsers;
    private NewReservationModal? NewReservationModal;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        reservations = await ReservationService.GetReservationsAsync();
        availableCars = await ReservationService.GetAvailableCarsAsync();
        authorizedUsers = await ReservationService.GetAuthorizedUsersAsync();
    }

    private void CreateNewReservation()
    {
        NewReservationModal?.Open();
    }

    private async Task SaveNewReservation(Reservation reservation)
    {
        await ReservationService.AddReservationAsync(reservation);
        await LoadData();
    }

    private async Task ReturnCar(int reservationId)
{
    var reservation = reservations?.FirstOrDefault(r => r.Id == reservationId);
    if (reservation != null)
    {
        reservation.DataZwrotu = DateTime.Now;
        await ReservationService.UpdateReservationAsync(reservation);
        await LoadData();
    }
}
    private async Task DeleteReservation(int id)
    {
        await ReservationService.DeleteReservationAsync(id);
        await LoadData();
    }
}