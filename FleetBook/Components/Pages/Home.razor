@page "/"
@using Microsoft.AspNetCore.Components.Authorization
@using FleetBook.Models
@using FleetBook.Services
@rendermode InteractiveServer
@inject CarApiService CarApiService

<div class="container mt-5">
    <h1>FleetBook</h1>
    <p>Witaj w systemie rezerwacji pojazd√≥w!</p>

    <AuthorizeView>
        <Authorized>
            <p>Zalogowany jako: <strong>@context.User.Identity?.Name</strong></p>

            @if (cars == null)
            {
                <p>≈Åadowanie listy samochod√≥w...</p>
            }
            else if (cars.Count == 0)
            {
                <p>Brak samochod√≥w w systemie.</p>
            }
            else
            {
                <table class="table table-striped mt-3">
                    <thead>
                        <tr>
                            <th>Id</th>
                            <th>Marka</th>
                            <th>Model</th>
                            <th>Rejestracja</th>
                            <th>Rok</th>
                            <th>Dostƒôpny</th>
                        </tr>
                    </thead>
                    <tbody>
                    @foreach (var car in cars)
                    {
                        <tr>
                            <td>@car.Id</td>
                            <td>@car.Marka</td>
                            <td>@car.Model</td>
                            <td>@car.Rejestracja</td>
                            <td>@car.Rok</td>
                            <td>@(car.Dostepny ? "Tak" : "Nie")</td>
                        </tr>
                    }
                    </tbody>
                </table>
            }
        </Authorized>
        <NotAuthorized>
            <p>Aby korzystaƒá z systemu, zaloguj siƒô.</p>
            <a href="/login" class="btn btn-primary">Przejd≈∫ do logowania</a>
        </NotAuthorized>
    </AuthorizeView>
</div>

@code {
    private List<CarDto>? cars;

    [CascadingParameter]
    private Task<AuthenticationState> AuthStateTask { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("üîç Home.OnInitializedAsync started");
        
        var authState = await AuthStateTask;
        Console.WriteLine($"üîç IsAuthenticated: {authState.User.Identity?.IsAuthenticated}");
        Console.WriteLine($"üîç User: {authState.User.Identity?.Name}");

        if (authState.User.Identity is null || !authState.User.Identity.IsAuthenticated)
        {
            Console.WriteLine("üîç User not authenticated, returning early");
            return;
        }

        Console.WriteLine("üîç Calling CarApiService.GetCarsAsync()");
        cars = await CarApiService.GetCarsAsync();
        Console.WriteLine($"üîç Got {cars?.Count ?? 0} cars from API");
    }
}
