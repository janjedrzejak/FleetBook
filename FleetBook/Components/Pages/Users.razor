@page "/users"
@using Microsoft.AspNetCore.Components.Authorization
@using FleetBook.Models
@using FleetBook.Services
@rendermode InteractiveServer
@inject UserApiService UserApiService
@inject IJSRuntime JS
@inject NavigationManager Navigation


<div class="container mt-5">
    <h1>üë• ZarzƒÖdzanie U≈ºytkownikami</h1>
    <p>Administrator - Panel zarzƒÖdzania u≈ºytkownikami systemu</p>

    <!-- Button to add new user -->
    <button class="btn btn-success mb-3" @onclick="OpenAddModal">
        <i class="bi bi-plus-circle"></i> Dodaj u≈ºytkownika
    </button>

    @if (users == null)
    {
        <p>≈Åadowanie listy u≈ºytkownik√≥w...</p>
    }
    else if (users.Count == 0)
    {
        <p>Brak u≈ºytkownik√≥w w systemie.</p>
    }
    else
    {
        <table class="table table-striped mt-3">
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Imiƒô</th>
                    <th>Nazwisko</th>
                    <th>Email</th>
                    <th>Tel</th>
                    <th>Uprawniony</th>
                    <th>Rola</th>
                    <th>Akcje</th>
                </tr>
            </thead>
            <tbody>
            @foreach (var user in users)
            {
                <tr>
                    <td>@user.Id</td>
                    <td>@user.Imie</td>
                    <td>@user.Nazwisko</td>
                    <td>@user.Email</td>
                    <td>@user.NumerTelefonu</td>
                    <td>
                        <span class="badge @(user.Uprawniony == 1 ? "bg-success" : "bg-warning")">
                            @(user.Uprawniony == 1 ? "Tak" : "Nie")
                        </span>
                    </td>
                    <td>
                        @if (userRoles.ContainsKey(user.Id) && userRoles[user.Id].Count > 0)
                        {
                            <span class="badge bg-info">@userRoles[user.Id][0].Name</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Brak</span>
                        }
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" @onclick="() => OpenEditModal(user)">
                            Edytuj
                        </button>
                        <button class="btn btn-sm btn-danger" @onclick="() => ConfirmDelete(user.Id)">
                            Usu≈Ñ
                        </button>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    }
</div>

<!-- Add/Edit Modal -->
<div class="modal @(showUserModal ? "show" : "")" id="userModal" tabindex="-1" style="@(showUserModal ? "display: block;" : "display: none;")">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">@(isEditMode ? "Edytuj u≈ºytkownika" : "Dodaj nowego u≈ºytkownika")</h5>
                <button type="button" class="btn-close" @onclick="CloseModal"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for="imie" class="form-label">Imiƒô</label>
                        <input type="text" class="form-control" id="imie" @bind="formUser.Imie" required />
                    </div>
                    <div class="mb-3">
                        <label for="nazwisko" class="form-label">Nazwisko</label>
                        <input type="text" class="form-control" id="nazwisko" @bind="formUser.Nazwisko" required />
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" @bind="formUser.Email" required />
                    </div>
                    <div class="mb-3">
                        <label for="telefon" class="form-label">Nr telefonu</label>
                        <input type="text" class="form-control" id="telefon" @bind="formUser.NumerTelefonu" />
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="uprawniony" @bind="isUprawniony" />
                        <label class="form-check-label" for="uprawniony">
                            Uprawniony do wypo≈ºycze≈Ñ
                        </label>
                    </div>

                    <!-- Roles Section - Radio Buttons (Single Selection) -->
                    @if (isEditMode && availableRoles != null && availableRoles.Count > 0)
                    {
                        <div class="mb-3">
                            <label class="form-label">Rola</label>
                            <div class="border p-3 rounded">
                                <div class="form-check mb-2">
                                    <input type="radio" class="form-check-input" id="role_none" name="userRole"
                                           @onchange="@((ChangeEventArgs e) => OnRoleChange(null))" 
                                           checked="@(selectedRoleId == null)" />
                                    <label class="form-check-label" for="role_none">
                                        Brak roli
                                    </label>
                                </div>
                                
                                @foreach (var role in availableRoles)
                                {
                                    <div class="form-check mb-2">
                                        <input type="radio" class="form-check-input" id="role_@role.Id" name="userRole"
                                               @onchange="@((ChangeEventArgs e) => OnRoleChange(role.Id))" 
                                               checked="@(selectedRoleId == role.Id)" />
                                        <label class="form-check-label" for="role_@role.Id">
                                            @role.Name
                                        </label>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger" role="alert">
                            @errorMessage
                        </div>
                    }
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="CloseModal">Anuluj</button>
                <button type="button" class="btn btn-primary" @onclick="SaveUser" disabled="@isLoading">
                    @(isLoading ? "Zapisywanie..." : "Zapisz")
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal backdrop -->
@if (showUserModal)
{
    <div class="modal-backdrop fade show"></div>
}

<!-- Temporary Password Modal - Simple & Clean -->
<div class="modal @(showPasswordModal ? "show" : "")" id="passwordModal" tabindex="-1" style="@(showPasswordModal ? "display: block;" : "display: none;")">
    <div class="modal-dialog modal-sm">
        <div class="modal-content border-success">
            <div class="modal-header border-success">
                <h5 class="modal-title">‚úÖ U≈ºytkownik utworzony</h5>
                <button type="button" class="btn-close" @onclick="ClosePasswordModal"></button>
            </div>
            <div class="modal-body">
                @if (!string.IsNullOrEmpty(newUserPassword))
                {
                    <p class="text-muted mb-3">Email: <strong>@newUserEmail</strong></p>
                    
                    <label class="form-label">Has≈Ço tymczasowe:</label>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control font-monospace fw-bold" id="passwordInput" value="@newUserPassword" readonly />
                        <button class="btn btn-outline-secondary" type="button" @onclick="CopyPassword" title="Kopiuj do schowka">
                            üìã
                        </button>
                    </div>
                    
                    <div class="alert alert-warning py-2 px-3 mb-0" role="alert">
                        <small>‚ö†Ô∏è Poka≈º has≈Ço u≈ºytkownikowi. Nie bƒôdzie widoczne po zamkniƒôciu.</small>
                    </div>
                }
            </div>
            <div class="modal-footer border-top">
                <button type="button" class="btn btn-success" @onclick="ClosePasswordModal">Gotowe</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal backdrop for password -->
@if (showPasswordModal)
{
    <div class="modal-backdrop fade show"></div>
}

<!-- Delete Confirmation Modal -->
<div class="modal @(showDeleteModal ? "show" : "")" id="deleteModal" tabindex="-1" style="@(showDeleteModal ? "display: block;" : "display: none;")">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Potwierdzenie usuniƒôcia</h5>
                <button type="button" class="btn-close" @onclick="CloseDeleteModal"></button>
            </div>
            <div class="modal-body">
                <p>Czy na pewno chcesz usunƒÖƒá tego u≈ºytkownika?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="CloseDeleteModal">Anuluj</button>
                <button type="button" class="btn btn-danger" @onclick="DeleteUser" disabled="@isLoading">
                    @(isLoading ? "Usuwanie..." : "Usu≈Ñ")
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal backdrop for delete -->
@if (showDeleteModal)
{
    <div class="modal-backdrop fade show"></div>
}

@code {
    private List<UserDto>? users;
    private UserDto formUser = new();
    private int deleteUserId;
    private bool isEditMode;
    private bool isLoading;
    private bool isUprawniony;
    private string errorMessage = "";
    private bool showUserModal;
    private bool showDeleteModal;
    private bool showPasswordModal;
    
    // Password modal data
    private string newUserPassword = "";
    private string newUserEmail = "";
    
    // Role management - SINGLE ROLE
    private List<RoleDto>? availableRoles;
    private int? selectedRoleId;  // Single role instead of List<int>
    private Dictionary<int, List<RoleDto>> userRoles = new();

    [CascadingParameter]
    private Task<AuthenticationState> AuthStateTask { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("üîç Users.OnInitializedAsync started");
        
        var authState = await AuthStateTask;
        
        if (authState.User.Identity is null || !authState.User.Identity.IsAuthenticated)
        {
            Console.WriteLine("üîç User not authenticated, redirecting to /login");
            Navigation.NavigateTo("/login", forceLoad: true);
            return;
        }

        Console.WriteLine("üîç Loading users and roles");
        users = await UserApiService.GetUsersAsync();
        availableRoles = await UserApiService.GetAllRolesAsync();
        
        // Load roles for each user
        if (users != null)
        {
            foreach (var user in users)
            {
                userRoles[user.Id] = await UserApiService.GetUserRolesAsync(user.Id);
            }
        }
        
        Console.WriteLine($"üîç Got {users?.Count ?? 0} users and {availableRoles?.Count ?? 0} roles");
    }

    private async Task OpenAddModal()
    {
        isEditMode = false;
        formUser = new UserDto();
        isUprawniony = false;
        selectedRoleId = null;
        errorMessage = "";
        showUserModal = true;
        StateHasChanged();
    }

    private async Task OpenEditModal(UserDto user)
    {
        isEditMode = true;
        formUser = new UserDto
        {
            Id = user.Id,
            Imie = user.Imie,
            Nazwisko = user.Nazwisko,
            Email = user.Email,
            NumerTelefonu = user.NumerTelefonu,
            Uprawniony = user.Uprawniony
        };
        isUprawniony = user.Uprawniony == 1;
        
        // Load user's single role
        selectedRoleId = null;
        var roles = await UserApiService.GetUserRolesAsync(user.Id);
        if (roles.Any())
        {
            selectedRoleId = roles.First().Id;
        }
        
        errorMessage = "";
        showUserModal = true;
        StateHasChanged();
    }

    private void OnRoleChange(int? roleId)
    {
        selectedRoleId = roleId;
    }

    private async Task SaveUser()
    {
        if (string.IsNullOrWhiteSpace(formUser.Imie) || string.IsNullOrWhiteSpace(formUser.Email))
        {
            errorMessage = "Imiƒô i email sƒÖ wymagane!";
            return;
        }

        formUser.Uprawniony = isUprawniony ? 1 : 0;
        
        isLoading = true;
        try
        {
            if (isEditMode)
            {
                // Edit mode
                var success = await UserApiService.UpdateUserAsync(formUser.Id, formUser);
                
                // Update role if edited (convert to List with single item or empty)
                if (success && availableRoles != null && availableRoles.Count > 0)
                {
                    var roleIds = selectedRoleId.HasValue ? new List<int> { selectedRoleId.Value } : new List<int>();
                    success = await UserApiService.UpdateUserRolesAsync(formUser.Id, roleIds);
                }

                if (success)
                {
                    users = await UserApiService.GetUsersAsync();
                    
                    // Reload all user roles
                    if (users != null)
                    {
                        userRoles.Clear();
                        foreach (var user in users)
                        {
                            userRoles[user.Id] = await UserApiService.GetUserRolesAsync(user.Id);
                        }
                    }
                    
                    await CloseModal();
                    errorMessage = "";
                }
                else
                {
                    errorMessage = "B≈ÇƒÖd podczas zapisywania u≈ºytkownika!";
                }
            }
            else
            {
                // Create mode - get response with password
                var response = await UserApiService.AddUserAsync(formUser);
                
                if (response != null)
                {
                    // Show password modal
                    newUserPassword = response.TemporaryPassword;
                    newUserEmail = response.Email;
                    showPasswordModal = true;
                    
                    // Reload users list
                    users = await UserApiService.GetUsersAsync();
                    
                    // Reload all user roles
                    if (users != null)
                    {
                        userRoles.Clear();
                        foreach (var user in users)
                        {
                            userRoles[user.Id] = await UserApiService.GetUserRolesAsync(user.Id);
                        }
                    }
                    
                    await CloseModal();
                    errorMessage = "";
                }
                else
                {
                    errorMessage = "B≈ÇƒÖd podczas tworzenia u≈ºytkownika!";
                }
            }
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task CopyPassword()
    {
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", newUserPassword);
        Console.WriteLine("üîç Password copied to clipboard");
    }

    private async Task ConfirmDelete(int id)
    {
        deleteUserId = id;
        showDeleteModal = true;
        StateHasChanged();
    }

    private async Task DeleteUser()
    {
        isLoading = true;
        try
        {
            var success = await UserApiService.DeleteUserAsync(deleteUserId);
            if (success)
            {
                users = await UserApiService.GetUsersAsync();
                userRoles.Remove(deleteUserId);
                await CloseDeleteModal();
            }
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task CloseModal()
    {
        showUserModal = false;
        formUser = new();
        isUprawniony = false;
        selectedRoleId = null;
        errorMessage = "";
        StateHasChanged();
    }

    private async Task ClosePasswordModal()
    {
        showPasswordModal = false;
        newUserPassword = "";
        newUserEmail = "";
        StateHasChanged();
    }

    private async Task CloseDeleteModal()
    {
        showDeleteModal = false;
        deleteUserId = 0;
        StateHasChanged();
    }
}

<style>
    .border-success {
        border-color: #198754 !important;
    }
    
    .font-monospace {
        font-family: 'Courier New', monospace;
        letter-spacing: 0.5px;
    }
    
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1050;
        width: 100%;
        height: 100%;
        overflow: hidden;
        outline: 0;
    }

    .modal.show {
        overflow-y: auto;
    }

    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1040;
        width: 100vw;
        height: 100vh;
        background-color: #000;
    }

    .modal-backdrop.show {
        opacity: 0.5;
    }

    .modal-dialog {
        position: relative;
        width: auto;
        margin: 1.75rem auto;
    }

    .modal-sm {
        max-width: 400px;
    }

    .modal-content {
        position: relative;
        display: flex;
        flex-direction: column;
        width: 100%;
        pointer-events: auto;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid rgba(0, 0, 0, 0.2);
        border-radius: 0.3rem;
        outline: 0;
    }

    .modal-header {
        display: flex;
        flex-shrink: 0;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
    }

    .modal-title {
        margin-bottom: 0;
        line-height: 1.5;
        font-size: 1.1rem;
        font-weight: 600;
    }

    .modal-body {
        position: relative;
        flex: 1 1 auto;
        padding: 1.5rem;
    }

    .modal-footer {
        display: flex;
        flex-wrap: wrap;
        flex-shrink: 0;
        align-items: center;
        justify-content: flex-end;
        padding: 1rem;
        border-top: 1px solid #dee2e6;
        gap: 0.5rem;
    }

    .btn-close {
        box-sizing: content-box;
        width: 1em;
        height: 1em;
        padding: 0.25em 0.25em;
        color: #000;
        background: transparent url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23000'%3e%3cpath d='M.293.293a1 1 0 0 1 1.414 0L8 6.586 14.293.293a1 1 0 1 1 1.414 1.414L9.414 8l6.293 6.293a1 1 0 0 1-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 0 1-1.414-1.414L6.586 8 .293 1.707a1 1 0 0 1 0-1.414z'/%3e%3c/svg%3e") center / 1em auto no-repeat;
        border: 0;
        border-radius: 0.3rem;
        opacity: 0.5;
        cursor: pointer;
    }

    .btn-close:hover {
        opacity: 0.75;
    }
</style>
